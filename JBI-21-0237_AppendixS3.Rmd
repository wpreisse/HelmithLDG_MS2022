---
title: "Taxonomic scale and community organization impact observed latitudinal gradients of parasite diversity"
author: "Whitney C. Preisser, Adrian A. Castellanos, John M. Kinsella, Ronald Vargas, Eugenio Gonzalez, Jesús A. Fernández, Norman O. Dronen, A. Michelle Lawing, Jessica E. Light"
date: '`r format(Sys.time(), "%d %B %Y")`'
output: 
  html_document:
    css: ~/R/win-library/4.0/knitr/misc/knitr.css
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load the packages that are needed for the downstream analyses. If you see anything here that is not installed already, please install them at this point (the rnaturalearth series of packages are only for the map data in the map making section, so feel free to skip those and that section if you so choose).
```{r, message = F, results = "hide", warning = F}
packages <- c("vegan", "lmtest", "DHARMa", "lme4", "geoR", "gstat", "sf", "sp",  "nlme", "MASS", "betapart", "tidyverse", "patchwork", "gdm", "vegan", "piecewiseSEM", "ape", "caper", "Rphylopars", "plyr", "lme4", "maps", "maptools", "mapdata", "rnaturalearth", "rnaturalearthdata", "rnaturalearthhires", "magrittr", "ggrepel", "MuMIn", "ggridges", "mgcv", "corrplot", "multiColl")
sapply(packages, library, character.only = T)
```

Load the SupplementalInformation_AppendixS2_6.15.csv file in from wherever you have it stored in your computer.
```{r}
mastersheet <- read.csv("C:/Users/castellanosa/Downloads/SupplementalInformation_AppendixS2_6.15.csv")
```

# Map making (Figure 2)

Let's start out with making Figure 2 of the manuscript, which will give you a general idea of where the sampling was done. If you are antsy to get started with looking at the models, feel free to head to the next chunk as nothing done here is needed for downstream analyses.
```{r, fig.width=8, fig.height=6, fig.cap="Map of sampling sites across North and Central America. Sampling sites were set approximately every 10 degrees in latitude, from Costa Rica (~10° N) to northern Manitoba, Canada (~58° N).", message=F}
#For all records not in Canada, find all unique Country-State combinations and summarise them to get the mean coords
map_coords <- mastersheet %>%
  filter(Country != "Canada") %>%
  group_by(Country, State) %>%
  dplyr::summarise(Longitude = mean(Longitude),
            Latitude = mean(Latitude))
#Canada has to be difficult, so we'll grab only the distinct coordinates, create a site variable by splitting locality by a space or comma, grouping by Country-State-site and summarising to get the mean coords
CAN <- mastersheet %>% 
  filter(Country == "Canada") %>%
  distinct(Longitude, Latitude, .keep_all = T) %>%
  mutate(site = sapply(.$Locality, function(i) strsplit(i, "\\s|,")[[1]][1])) %>%
  group_by(Country, State, site) %>%
  dplyr::summarise(Longitude = mean(Longitude),
            Latitude = mean(Latitude))
#put these two together and add a name variable
map_coords <- rbind(CAN[, c(1:2, 4:5)], map_coords) %>%
  as.data.frame() %>%
  mutate(Name = c("Churchill, Manitoba, Canada",
                  "Winnipeg, Manitoba, Canada",
                  "San Juan de Pe\u00F1as Blancas, Costa Rica",
                  "Calnali, Hidalgo, Mexico",
                  "Brownsville, Nebraska, USA",
                  "College Station, Texas, USA"))
#read in rnaturalearth data at a high resolution ("large")
WRLD <- ne_countries(scale = "large", returnclass = "sf") %>%
  mutate(site = ifelse(iso_a3 %in% c("USA", "CAN", "MEX", "CRI"), "1", "0"))

NAmap <- WRLD %>% ggplot() +
  theme_bw() +
  geom_sf(#aes(fill = site),
          color = "black",
          size = 0.3,
          show.legend = F,
          fill = "grey88") +
  #geom_sf(data = WTR,
  #        fill = "white",
  #        color = "black",
  #        size = 0.3) +
  coord_sf(xlim = c(-130, -60),
           ylim = c(5, 65), expand = F) +
  scale_fill_manual(values = c("white", "grey88")) +
  geom_point(data=map_coords,
             aes(x=Longitude, y=Latitude),
             fill="red",
             color = "black",
             shape=21,
             size=3.0) +
  labs(x = "Longitude", y = "Latitude") +
  geom_label_repel(data = map_coords,
                   aes(Longitude,
                       Latitude,
                       label = Name),
                   size = 3,
                   box.padding = unit(0.1, 'lines'),
                   force = 1,
                   nudge_y=3,
                   min.segment.length = Inf)
NAmap
#ggsave(NAmap, filename = "NAmapR.png", scale = 1, width = 8, height = 6, dpi = 300, limitsize = TRUE, units = "in", device = "png")
```


# Cleaning data

Here we generate total numbers of helminths, nematodes, cestodes, and trematodes found for each row in our dataset, rename the WorldClim data to make more intuitive sense, and pare down the dataset for future analysis.
```{r}
#colnames(mastersheet)
#standardize our parasite data to presence/absence using {vegan}
datasheetPA <- decostand(x=mastersheet[,38:112], method="pa")
#just in case cbind doesn't link merging, we'll change the column names slightly
colnames(datasheetPA) <- paste0(colnames(datasheetPA), "_pa")
mastersheet2<-cbind(mastersheet, datasheetPA)
#head(mastersheet2)
HELMS <- colnames(mastersheet)[38:112]
#HELMS
NEMS <- colnames(mastersheet)[38:86]
#NEMS
CEST <- colnames(mastersheet)[c(89, 95:100, 104:106, 108:110)]
#CEST
TREM <- colnames(mastersheet)[c(87:88, 90:94, 101:103, 107, 111:112)]
#TREM
```

```{r}
#Create columns for richness of each taxonomic group
#colnames(mastersheet2)
mastersheet2$TotalHelms<-rowSums(mastersheet2[,113:187])
mastersheet2$NemRich<-rowSums(mastersheet2[,113:161])
mastersheet2$CestRich<-rowSums(mastersheet2[,c(164,170:175,179:181,183:185)])
mastersheet2$TremRich<-rowSums(mastersheet2[,c(162,163,165:169,176:178,182,186:187)])
```

Let's rename the WorldClim data columns while we are here.
```{r}
mastersheet2$AnnMeanTemp<-mastersheet2$wc2.0_bio_30s_01
mastersheet2$MeanDiurnRange<-mastersheet2$wc2.0_bio_30s_02
mastersheet2$Isothermality<-mastersheet2$wc2.0_bio_30s_03
mastersheet2$TempSeasonal<-mastersheet2$wc2.0_bio_30s_04
mastersheet2$MaxTempWarmMonth<-mastersheet2$wc2.0_bio_30s_05
mastersheet2$MinTempColdMonth<-mastersheet2$wc2.0_bio_30s_06
mastersheet2$TempAnnRange<-mastersheet2$wc2.0_bio_30s_07
mastersheet2$MeanTempWetQ<-mastersheet2$wc2.0_bio_30s_08
mastersheet2$MeanTempDryQ<-mastersheet2$wc2.0_bio_30s_09
mastersheet2$MeanTempWarmQ<-mastersheet2$wc2.0_bio_30s_10
mastersheet2$MeanTempColdQ<-mastersheet2$wc2.0_bio_30s_11
mastersheet2$AnnPrecip<-mastersheet2$wc2.0_bio_30s_12
mastersheet2$PrecipWetMonth<-mastersheet2$wc2.0_bio_30s_13
mastersheet2$PrecipDryMonth<-mastersheet2$wc2.0_bio_30s_14
mastersheet2$PrecipSeason<-mastersheet2$wc2.0_bio_30s_15
mastersheet2$PrecipWetQ<-mastersheet2$wc2.0_bio_30s_16
mastersheet2$PrecipDryQ<-mastersheet2$wc2.0_bio_30s_17
mastersheet2$PrecipWarmQ<-mastersheet2$wc2.0_bio_30s_18
mastersheet2$PrecipColdQ<-mastersheet2$wc2.0_bio_30s_19
#head(mastersheet2)
#colnames(mastersheet2)
#Remove the old data columns
mastersheet2<-mastersheet2[,-c(19:37)]
#Shuffle things around for easier downstream analysis
mastersheet2<-mastersheet2[,c(1:18,173:190,169:172,19:168)]
#head(mastersheet2)
```

# Infracommunity Analysis - GAMs 

For this first section of models, we will be looking at infracommunities, which is a scale at the level of the host individual in which we will look at the parasite populations within a single host. For this and all other analyses, we will be using general additive models with the `mgcv` package. 

## Test for Relationship between Richness and Latitude {.tabset}

First, we will be using latitude as a predictor variable to understand how species richness change across latitudes. We will be breaking this up into models for total helminths, nematodes, cestodes, and trematodes.

```{r, eval = F}
colnames(mastersheet2)
```
```{r}
colltest<-mastersheet2[,c(37,17,25,33)]
colltest<-colltest[-c(151),]
colltest$Mass
CN(colltest)
#5.655839
```
```{r, eval = F}
as.factor(mastersheet2$species)
```

### Total Helminths
```{r}
gam_mod <- gam(TotalHelms ~ s(Latitude, k=5), data = mastersheet2, method="REML", family=poisson(link="log"))
coef(gam_mod)
jpeg(file="Plot_Infra_Tot_Lat.jpeg", width = 7, height = 7, units = "in", res = 300)
plotHLat<-plot(gam_mod, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod)[1], cex=4, ylab = "s(Latitude)")
dev.off()
summary(gam_mod)
#quality check - should have non-significant p-value. if sig, increase k. must converge.
gam.check(gam_mod)
#checking for concurvity - want them to be low. if too high (>0.8), inspect and be careful with interpretations
concurvity(gam_mod, full=TRUE)
```

Do we see similar results with removing one latitude?
```{r}
TEST <- foreach(i = unique(mastersheet2$Latitude), .combine = "rbind.data.frame") %do% {
  alt <- mastersheet2 %>%
    filter(Latitude != i)
  GM <- gam(TotalHelms ~ s(Latitude, k=5), data = alt, method="REML", family=poisson(link="log"))
  c(summary(GM)$s.pv, summary(GM)$r.sq, summary(GM)$dev.expl)
}
CONF <- apply(TEST, 2, function(i) t.test(i)$conf.int)
colnames(CONF) <- c("p_value", "Rsq", "DevExp")
CONF
```

### Nematodes
```{r}
gam_modN <- gam(NemRich ~ s(Latitude, k=6), data = mastersheet2, method="REML", family=poisson(link="log"))
coef(gam_modN)
jpeg(file="Plot_Infra_Nem_Lat.jpeg", width = 7, height = 7, units = "in", res = 300)
plot(gam_modN, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_modN)[1], cex=4)
dev.off()
summary(gam_modN)
gam.check(gam_modN)
concurvity(gam_modN, full=TRUE)
```

Do we see similar results with removing one latitude?
```{r}
TEST <- foreach(i = unique(mastersheet2$Latitude), .combine = "rbind.data.frame") %do% {
  alt <- mastersheet2 %>%
    filter(Latitude != i)
  GM <- gam(NemRich ~ s(Latitude, k=6), data = alt, method="REML", family=poisson(link="log"))
  c(summary(GM)$s.pv, summary(GM)$r.sq, summary(GM)$dev.expl)
}
CONF <- apply(TEST, 2, function(i) t.test(i)$conf.int)
colnames(CONF) <- c("p_value", "Rsq", "DevExp")
CONF
```

### Cestodes
```{r}    
max(mastersheet2$CestRich)#highest richness is 3
mastersheet2$State[256] #highest richness is in texas
gam_modC <- gam(CestRich ~ s(Latitude, k=4), data = mastersheet2, method="REML", family=poisson(link="log"))
coef(gam_modC)
jpeg(file="Plot_Infra_Cest_Lat.jpeg", width = 7, height = 7, units = "in", res = 300)
plot(gam_modC, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_modC)[1], cex=4)
dev.off()
summary(gam_modC)
gam.check(gam_modC)
concurvity(gam_modC, full=TRUE)
hist(mastersheet2$CestRich)
```

Do we see similar results with removing one latitude?
```{r}
TEST <- foreach(i = unique(mastersheet2$Latitude), .combine = "rbind.data.frame") %do% {
  alt <- mastersheet2 %>%
    filter(Latitude != i)
  GM <- gam(CestRich ~ s(Latitude, k=4), data = alt, method="REML", family=poisson(link="log"))
  c(summary(GM)$s.pv, summary(GM)$r.sq, summary(GM)$dev.expl)
}
CONF <- apply(TEST, 2, function(i) t.test(i)$conf.int)
colnames(CONF) <- c("p_value", "Rsq", "DevExp")
CONF
```

### Trematodes
```{r}
gam_modT <- gam(TremRich ~ Latitude, data = mastersheet2, method="REML", family=poisson(link="log"))
#coef(gam_modT)
#plot(gam_modT, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_modT)[1])
summary(gam_modT)
gam.check(gam_modT)
#concurvity(gam_modT, full=TRUE)
#hist(mastersheet2$TremRich)
#jpeg(file="Plot_Infra_Nem_Lat.jpeg", width = 7, height = 7, units = "in", res = 300)
#dev.off()
#Trem data is linear - zero inflated, some richnesses of 1, one richness of 2
```

## Test for Relationship between Richness and Climate Variables and Mass {.tabset}

Next, we will also use GAMs to test for the relationship of our climate variables (annual temperature range and precipitation seasonality) and host body mass with richness. As above, we break these models into ones for total helminths, nematodes, cestodes, and trematodes. 

```{r}
climdata<-mastersheet2[,c(19:36)]
climdataCor<-cor(climdata)
corrplot(climdataCor)
```

```{r}
mastersheetA<-mastersheet2[-151,]
mastersheetA$Mass
```

### Total Helminths 

```{r}
gam_mod2 <- gam(TotalHelms ~ s(PrecipSeason, k=3) + s(TempAnnRange, k=3) + s(Mass, k=3) + s(as.factor(mastersheetA$species), Mass, bs="re"), data = mastersheetA, method="REML", family=poisson(link="log"))
summary(gam_mod2)
coef(gam_mod2)
gam.check(gam_mod2)
concurvity(gam_mod2, full=FALSE)
jpeg(file="Plot_Infra_Tot_Precip.jpeg", width = 7, height = 7, units = "in", res = 300)
I.H.P<-plot(gam_mod2, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2)[1], select=1, cex=4)
dev.off()
jpeg(file="Plot_Infra_Tot_Temp.jpeg", width = 7, height = 7, units = "in", res = 300)
I.H.T<-plot(gam_mod2, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2)[1], select=2, cex=4)
dev.off()
jpeg(file="Plot_Infra_Tot_Mass.jpeg", width = 7, height = 7, units = "in", res = 300)
I.H.M<-plot(gam_mod2, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2)[1], select=3, cex=4)
dev.off()
```

Do we see similar results with removing one latitude?
```{r}
TEST <- foreach(i = unique(mastersheetA$Latitude), .combine = "rbind.data.frame") %do% {
  alt <- mastersheetA %>%
    filter(Latitude != i)
  GM <- gam(TotalHelms ~ s(PrecipSeason, k=3) + s(TempAnnRange, k=3) + s(Mass, k=3) + s(as.factor(alt$species), Mass, bs="re"), data = alt, method="REML", family=poisson(link="log"))

  c(summary(GM)$s.pv, summary(GM)$r.sq, summary(GM)$dev.expl)
}
CONF <- apply(TEST, 2, function(i) t.test(i)$conf.int)
colnames(CONF) <- c("p_value_prec", "p_value_temp", "p_value_mass", "p_value_host", "Rsq", "DevExp")
CONF
```

### Nematodes 

```{r}
gam_mod2N <- gam(NemRich ~ s(PrecipSeason, k=3) + s(TempAnnRange, k=3) + s(Mass, k=3)+ s(as.factor(mastersheetA$species), Mass, bs="re"), data = mastersheetA, method="REML", family=poisson(link="log"))
summary(gam_mod2N)
coef(gam_mod2N)
gam.check(gam_mod2N)
concurvity(gam_mod2N, full=FALSE)
jpeg(file="Plot_Infra_Nem_Precip.jpeg", width = 7, height = 7, units = "in", res = 300)
I.N.P<-plot(gam_mod2N, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2N)[1], select=1, cex=4)
dev.off()
jpeg(file="Plot_Infra_Nem_Temp.jpeg", width = 7, height = 7, units = "in", res = 300)
I.N.T<-plot(gam_mod2N, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2N)[1], select=2, cex=4)
dev.off()
jpeg(file="Plot_Infra_Nem_Mass.jpeg", width = 7, height = 7, units = "in", res = 300)
I.N.M<-plot(gam_mod2N, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2N)[1], select=3, cex=4)
dev.off()
```

Do we see similar results with removing one latitude?
```{r}
TEST <- foreach(i = unique(mastersheetA$Latitude), .combine = "rbind.data.frame") %do% {
  alt <- mastersheetA %>%
    filter(Latitude != i)
  GM <- gam(NemRich ~ s(PrecipSeason, k=3) + s(TempAnnRange, k=3) + s(Mass, k=3) + s(as.factor(alt$species), Mass, bs="re"), data = alt, method="REML", family=poisson(link="log"))

  c(summary(GM)$s.pv, summary(GM)$r.sq, summary(GM)$dev.expl)
}
CONF <- apply(TEST, 2, function(i) t.test(i)$conf.int)
colnames(CONF) <- c("p_value_prec", "p_value_temp", "p_value_mass", "p_value_host", "Rsq", "DevExp")
CONF
```

### Cestodes

```{r}
gam_mod2C <- gam(CestRich ~ PrecipSeason + s(TempAnnRange, k=3) + s(Mass, k=3)+ s(as.factor(mastersheetA$species), Mass, bs="re"), data = mastersheetA, method="REML", family=poisson(link="log"))
summary(gam_mod2C)
coef(gam_mod2C)
gam.check(gam_mod2C)
concurvity(gam_mod2C, full=FALSE)
#must rerun model with smooth term and k=3 around precip in order to get graph
jpeg(file="Plot_Infra_Cest_Precip.jpeg", width = 7, height = 7, units = "in", res = 300)
I.C.P<-plot(gam_mod2C, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2C)[1], select=1, cex=4)
dev.off()
jpeg(file="Plot_Infra_Cest_Temp.jpeg", width = 7, height = 7, units = "in", res = 300)
I.C.T<-plot(gam_mod2C, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2C)[1], select=2, cex=4)
dev.off()
jpeg(file="Plot_Infra_Cest_Mass.jpeg", width = 7, height = 7, units = "in", res = 300)
I.C.M<-plot(gam_mod2C, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2C)[1], select=3, cex=4)
dev.off()
```

Do we see similar results with removing one latitude?
```{r}
TEST <- foreach(i = unique(mastersheetA$Latitude), .combine = "rbind.data.frame") %do% {
  alt <- mastersheetA %>%
    filter(Latitude != i)
  GM <- gam(CestRich ~ PrecipSeason + s(TempAnnRange, k=3) + s(Mass, k=3) + s(as.factor(alt$species), Mass, bs="re"), data = alt, method="REML", family=poisson(link="log"))
  c(summary(GM)$p.pv[2], summary(GM)$s.pv, summary(GM)$r.sq, summary(GM)$dev.expl)
}
CONF <- apply(TEST, 2, function(i) t.test(i)$conf.int)
colnames(CONF) <- c("p_value_prec", "p_value_temp", "p_value_mass", "p_value_host", "Rsq", "DevExp")
CONF
```

### Trematodes

```{r}
gam_mod2T <- gam(TremRich ~ s(PrecipSeason, k=3) + s(TempAnnRange, k=3) + s(Mass, k=3)+ s(as.factor(mastersheetA$species), Mass, bs="re"), data = mastersheetA, method="REML", family=poisson(link="log"))
summary(gam_mod2T)
coef(gam_mod2T)
gam.check(gam_mod2T)
concurvity(gam_mod2T, full=FALSE)
plot(gam_mod2T, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2T)[1], cex=4)
#must rerun model with smooth term and k=3 around precip and temp in order to get graph
jpeg(file="Plot_Infra_Trem_Precip.jpeg", width = 7, height = 7, units = "in", res = 300)
I.T.P<-plot(gam_mod2T, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2T)[1], select=1, cex=4)
dev.off()
jpeg(file="Plot_Infra_Trem_Temp.jpeg", width = 7, height = 7, units = "in", res = 300)
I.T.T<-plot(gam_mod2T, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2T)[1], select=2, cex=4)
dev.off()
jpeg(file="Plot_Infra_Trem_Mass.jpeg", width = 7, height = 7, units = "in", res = 300)
I.T.M<-plot(gam_mod2T, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2T)[1], select=3, cex=4)
dev.off()
```

Do we see similar results with removing one latitude?
```{r}
TEST <- foreach(i = unique(mastersheetA$Latitude), .combine = "rbind.data.frame") %do% {
  alt <- mastersheetA %>%
    filter(Latitude != i)
  GM <- gam(TremRich ~ s(PrecipSeason, k=3) + s(TempAnnRange, k=3) + s(Mass, k=3)+ s(as.factor(alt$species), Mass, bs="re"), data = alt, method="REML", family=poisson(link="log"))
  c(summary(GM)$s.pv, summary(GM)$r.sq, summary(GM)$dev.expl)
}
CONF <- apply(TEST, 2, function(i) t.test(i)$conf.int)
colnames(CONF) <- c("p_value_prec", "p_value_temp", "p_value_mass", "p_value_host", "Rsq", "DevExp")
CONF
```

# Component community analyses

As described in the manuscript, component communities contain all of the infracommunities of a particular host species. 

```{r}
Churchill_datasheet<-mastersheet2[mastersheet2$Latitude > 55,]
#Churchill_datasheet
Winnipeg_datasheet<-mastersheet2[mastersheet2$Latitude < 55 & mastersheet2$Latitude > 45,]
#Winnipeg_datasheet
Nebraska_datasheet<-mastersheet2[mastersheet2$Latitude < 45 & mastersheet2$Latitude > 35,]
#Nebraska_datasheet
Texas_datasheet<-mastersheet2[mastersheet2$Latitude < 35 & mastersheet2$Latitude > 25,]
#Texas_datasheet
Mexico_datasheet<-mastersheet2[mastersheet2$Latitude < 25 & mastersheet2$Latitude > 15,]
#Mexico_datasheet
CostaRica_datasheet<-mastersheet2[mastersheet2$Latitude < 15 & mastersheet2$Latitude > 5,]
#CostaRica_datasheet
```

For each unique species found at each of our sites, we aggregate the parasite records found and grab the mean climatic, coordinate, and body mass data.
```{r}
#colnames(Churchill_datasheet)
#unique(Churchill_datasheet$species)
Churchill_agg1<-aggregate(Churchill_datasheet[,c(41:190)], list(Churchill_datasheet$species), sum)
Churchill_agg2<-aggregate(Churchill_datasheet[,c(14,15,17,19:36)], list(Churchill_datasheet$species), mean)
Churchill_CC2<-cbind(Churchill_agg2,Churchill_agg1)
#colnames(Churchill_CC2)
Churchill_CC1<-Churchill_CC2[,-c(23,99:173)]
#head(Churchill_CC1)

#unique(Winnipeg_datasheet$species)
Winnipeg_agg1<-aggregate(Winnipeg_datasheet[,c(41:190)], list(Winnipeg_datasheet$species), sum)
Winnipeg_agg2<-aggregate(Winnipeg_datasheet[,c(14,15,17,19:36)], list(Winnipeg_datasheet$species), mean)
Winnipeg_CC2<-cbind(Winnipeg_agg2,Winnipeg_agg1)
Winnipeg_CC1<-Winnipeg_CC2[,-c(23,99:173)]
#head(Winnipeg_CC1)

#unique(Nebraska_datasheet$species)
Nebraska_agg1<-aggregate(Nebraska_datasheet[,c(41:190)], list(Nebraska_datasheet$species), sum)
Nebraska_agg2<-aggregate(Nebraska_datasheet[,c(14,15,17,19:36)], list(Nebraska_datasheet$species), mean)
Nebraska_CC2<-cbind(Nebraska_agg2,Nebraska_agg1)
Nebraska_CC1<-Nebraska_CC2[,-c(23,99:173)]
#head(Nebraska_CC1)

#head(Texas_datasheet)
Texas_datasheet<-Texas_datasheet[-2,] #remove species with missing data
#unique(Texas_datasheet$species)
#Texas_datasheet$ID2
Texas_agg1<-aggregate(Texas_datasheet[,c(41:190)], list(Texas_datasheet$species), sum)
Texas_agg2<-aggregate(Texas_datasheet[,c(14,15,17,19:36)], list(Texas_datasheet$species), mean)
Texas_CC2<-cbind(Texas_agg2,Texas_agg1)
Texas_CC1<-Texas_CC2[,-c(23,99:173)]
#head(Texas_CC1)

#unique(Mexico_datasheet$species)
Mexico_agg1<-aggregate(Mexico_datasheet[,c(41:190)], list(Mexico_datasheet$species), sum)
Mexico_agg2<-aggregate(Mexico_datasheet[,c(14,15,17,19:36)], list(Mexico_datasheet$species), mean)
Mexico_CC2<-cbind(Mexico_agg2,Mexico_agg1)
Mexico_CC1<-Mexico_CC2[,-c(23,99:173)]
#head(Mexico_CC1)

#unique(CostaRica_datasheet$species)
CostaRica_agg1<-aggregate(CostaRica_datasheet[,c(41:190)], list(CostaRica_datasheet$species), sum)
CostaRica_agg2<-aggregate(CostaRica_datasheet[,c(14,15,17,19:36)], list(CostaRica_datasheet$species), mean)
CostaRica_CC2<-cbind(CostaRica_agg2,CostaRica_agg1)
CostaRica_CC1<-CostaRica_CC2[,-c(23,99:173)]
#head(CostaRica_CC1)
CC_mastersheet<-rbind(Churchill_CC1, Winnipeg_CC1, Nebraska_CC1, Texas_CC1, Mexico_CC1, CostaRica_CC1)
#colnames(CC_mastersheet)
```

```{r}
#standardize the parasite data by presence/absence using {vegan}
#colnames(CC_mastersheet)
CC_mastersheetPA <- decostand(x=CC_mastersheet[,23:97], method="pa")
CC_mastersheet2<-cbind(CC_mastersheet, CC_mastersheetPA)
#head(CC_mastersheet2)
#remove old parasite columns
CC_mastersheet3<-CC_mastersheet2[,-c(23:97)]
#colnames(CC_mastersheet3)
#create new richness measures for each group of interest
CC_mastersheet3$TotalHelm<-rowSums(CC_mastersheet3[,c(23:97)])
CC_mastersheet3$Nem<-rowSums(CC_mastersheet3[,c(23:71)])
CC_mastersheet3$Cest<-rowSums(CC_mastersheet3[,c(74,80:85,89:91,93:95)])
CC_mastersheet3$Trem<-rowSums(CC_mastersheet3[,c(72:73,75:79,86:88,92,96:97)])
#create species names
CC_mastersheet3$species<-CC_mastersheet3$Group.1
```

Here, we check for a relationship between sample size and richness
```{r}
#unique(Churchill_datasheet$species)
SS_C_MP<-sum(Churchill_datasheet$species == "Microtus_pennsylvanicus")
SS_C_SB<-sum(Churchill_datasheet$species == "Synaptomys_borealis")

#unique(Winnipeg_datasheet$species)
SS_W_MP<-sum(Winnipeg_datasheet$species == "Microtus_pennsylvanicus")
SS_W_MG<-sum(Winnipeg_datasheet$species == "Myodes_gapperi")
SS_W_PM<-sum(Winnipeg_datasheet$species == "Peromyscus_maniculatus")

#unique(Nebraska_datasheet$species)
SS_N_PL<-sum(Nebraska_datasheet$species == "Peromyscus_leucopus")
SS_N_MPi<-sum(Nebraska_datasheet$species == "Microtus_pinetorum")
SS_N_MO<-sum(Nebraska_datasheet$species == "Microtus_ochrogaster")
SS_N_PM<-sum(Nebraska_datasheet$species == "Peromyscus_maniculatus")
SS_N_MP<-sum(Nebraska_datasheet$species == "Microtus_pennsylvanicus")
SS_N_RMo<-sum(Nebraska_datasheet$species == "Reithrodontomys_montanus")
SS_N_RM<-sum(Nebraska_datasheet$species == "Reithrodontomys_megalotis")

#unique(Texas_datasheet$species)
SS_T_PL<-sum(Texas_datasheet$species == "Peromyscus_leucopus")
SS_T_SH<-sum(Texas_datasheet$species == "Sigmodon_hispidus")
SS_T_RF<-sum(Texas_datasheet$species == "Reithrodontomys_fulvescens")
SS_T_BT<-sum(Texas_datasheet$species == "Baiomys_taylori")

#unique(Mexico_datasheet$species)
SS_M_PL<-sum(Mexico_datasheet$species == "Peromyscus_leucopus")
SS_M_PA<-sum(Mexico_datasheet$species == "Peromyscus_aztecus")
SS_M_OCo<-sum(Mexico_datasheet$species == "Oryzomys_couesi")
SS_M_PF<-sum(Mexico_datasheet$species == "Peromyscus_furvus")
SS_M_OCh<-sum(Mexico_datasheet$species == "Oryzomys_chapmani")
SS_M_OF<-sum(Mexico_datasheet$species == "Oligoryzomys_fulvescens")
SS_M_OR<-sum(Mexico_datasheet$species == "Oryzomys_rostratus")
SS_M_SH<-sum(Mexico_datasheet$species == "Sigmodon_hispidus")

#unique(CostaRica_datasheet$species)
SS_CR_MC<-sum(CostaRica_datasheet$species == "Melanomys_caliginosus")
SS_CR_OF<-sum(CostaRica_datasheet$species == "Oligoryzomys_fulvescens")
SS_CR_OB<-sum(CostaRica_datasheet$species == "Oryzomys_bolivaris")
SS_CR_C1<-sum(CostaRica_datasheet$species == "Cricetid_sp1")
SS_CR_PM<-sum(CostaRica_datasheet$species == "Peromyscus_mexicanus")
SS_CR_C2<-sum(CostaRica_datasheet$species == "Cricetid_sp2")

SS_CC<-c(SS_C_MP,SS_C_SB,SS_W_MP,SS_W_MG,SS_W_PM,SS_N_MO,SS_N_MP,SS_N_MPi,SS_N_PL,SS_N_PM,SS_N_RM,SS_N_RMo,SS_T_BT,SS_T_PL,SS_T_RF,SS_T_SH,SS_M_OF,SS_M_OCh,SS_M_OCo,SS_M_OR,SS_M_PA,SS_M_PF,SS_M_PL,SS_M_SH,SS_CR_C1,SS_CR_C2,SS_CR_MC,SS_CR_OF,SS_CR_OB,SS_CR_PM)
```

```{r}
CC_Species<-c("C_Microtus_pennsylvanicus","C_Synaptomys_borealis",
              "W_Microtus_pennsylvanicus","W_Myodes_gapperi","W_Peromyscus_maniculatus",
              "N_Microtus_ochrogaster","N_Microtus_pennsylvanicus","N_Microtus_pinetorum","N_Peromyscus_leucopus","N_Peromyscus_maniculatus","N_Reithrodontomys_megalotis","N_Reithrodontomys_montanus",
              "T_Baiomys_taylori","T_Peromyscus_leucopus","T_Reithrodontomys_fulvescens","T_Sigmodon_hispidus",
              "M_Oligoryzomys_fulvescens","M_Oryzomys_chapmani","M_Oryzomys_couesi","M_Oryzomys_rostratus",
              "M_Peromyscus_aztecus","M_Peromyscus_furvus","M_Peromyscus_leucopus","M_Sigmodon_hispidus",
              "C_Cricetid_sp1","C_Cricetid_sp2","C_Melanomys_caliginosus","C_Oligoryzomys_fulvescens","C_Oryzomys_bolivaris","C_Peromyscus_mexicanus")

SS_datasheet<-data.frame(SS_CC,CC_Species)

CC_mastersheet4<-cbind(CC_mastersheet3,SS_datasheet)
CC_mastersheet5<-CC_mastersheet4[,c(1,102,103,98:101,2:22)]
colnames(CC_mastersheet5)
```

```{r}
SS_TotalHelms<-lm(TotalHelm~SS_CC, data=CC_mastersheet5)
summary(SS_TotalHelms)
#YES

SS_Nem<-lm(Nem~SS_CC, data=CC_mastersheet5)
summary(SS_Nem)
#NO

SS_Cest<-lm(Cest~SS_CC, data=CC_mastersheet5)
summary(SS_Cest)
#YES

SS_Trem<-lm(Trem~SS_CC, data=CC_mastersheet5)
summary(SS_Trem)
#NO
```

Checking the condition number of the climate variables to make sure they aren't too correlated here either
```{r}
#colnames(CC_mastersheet3)
colltest<-CC_mastersheet3[,c(98,4,19,11)]
CN(colltest)
#5.269996
CC_mastersheet3[1,]
CC_mastersheet5[,2]
CC_mastersheet6<-CC_mastersheet5[CC_mastersheet5$SS_CC > 2,]
CC_mastersheet6$SS_CC
```

## Test for Relationship between Richness and Latitude {.tabset}

These models are similarly set up to the ones in the sections above for infracommunities, so see the explanation there or in the manuscript. 

### Total Helminths

```{r}
gam_modCC <- gam(TotalHelm ~ s(Latitude, k=3), data = CC_mastersheet6, method="REML", family=poisson(link="log"), offset=log10(SS_CC))
coef(gam_modCC)
jpeg(file="Plot_CC_Tot_Lat.jpeg", width = 7, height = 7, units = "in", res = 300)
plot(gam_modCC, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_modCC)[1], cex=4)
dev.off()
summary(gam_modCC)
gam.check(gam_modCC)
concurvity(gam_modCC, full=TRUE)
```

Do we see similar results with removing one data point?
```{r}
TEST <- foreach(i = 1:nrow(CC_mastersheet6), .combine = "rbind.data.frame") %do% {
  alt <- CC_mastersheet6[-i, ]
  GM <- gam(TotalHelm ~ s(Latitude, k=3), data = alt, method="REML", family=poisson(link="log"), offset=log10(SS_CC))
  c(summary(GM)$s.pv, summary(GM)$r.sq, summary(GM)$dev.expl)
}
CONF <- apply(TEST, 2, function(i) t.test(i)$conf.int)
colnames(CONF) <- c("p_value", "Rsq", "DevExp")
CONF
```

### Nematodes
```{r}
gam_modNCC <- gam(Nem ~ Latitude, data = CC_mastersheet6, method="REML", family=poisson(link="log"))
coef(gam_modNCC)
#must add smooth term and k=3
#jpeg(file="Plot_CC_Nem_Lat.jpeg", width = 7, height = 7, units = "in", res = 300)
#plot(gam_modNCC, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_modNCC)[1], cex=4)
#dev.off()
summary(gam_modNCC)
gam.check(gam_modNCC)
#concurvity(gam_modNCC, full=TRUE)
```

Do we see similar results with removing one data point?
```{r}
TEST <- foreach(i = 1:nrow(CC_mastersheet6), .combine = "rbind.data.frame") %do% {
  alt <- CC_mastersheet6[-i, ]
  GM <- gam(Nem ~ Latitude, data = alt, method="REML", family=poisson(link="log"))
  c(summary(GM)$p.pv[2], summary(GM)$r.sq, summary(GM)$dev.expl)
}
CONF <- apply(TEST, 2, function(i) t.test(i)$conf.int)
colnames(CONF) <- c("p_value", "Rsq", "DevExp")
CONF
```

### Cestodes

```{r}
gam_modCCC <- gam(Cest ~ s(Latitude, k=3), data = CC_mastersheet6, method="REML", family=poisson(link="log"), offset=log10(SS_CC))
coef(gam_modCCC)
jpeg(file="Plot_CC_Cest_Lat.jpeg", width = 7, height = 7, units = "in", res = 300)
plot(gam_modCCC, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_modCCC)[1], cex=4)
dev.off()
summary(gam_modCCC)
gam.check(gam_modCCC)
concurvity(gam_modCCC, full=TRUE)
hist(mastersheet2$CestRich)
```

Do we see similar results with removing one data point?
```{r}
TEST <- foreach(i = 1:nrow(CC_mastersheet6), .combine = "rbind.data.frame") %do% {
  alt <- CC_mastersheet6[-i, ]
  GM <- gam(Cest ~ s(Latitude, k=3), data = alt, method="REML", family=poisson(link="log"), offset=log10(SS_CC))
  c(summary(GM)$s.pv, summary(GM)$r.sq, summary(GM)$dev.expl)
}
CONF <- apply(TEST, 2, function(i) t.test(i)$conf.int)
colnames(CONF) <- c("p_value", "Rsq", "DevExp")
CONF
```

### Trematodes

```{r}
gam_modTCC <- gam(Trem ~ s(Latitude, k=3), data = CC_mastersheet6, method="REML", family=poisson(link="log"))
coef(gam_modTCC)
jpeg(file="Plot_CC_Trem_Lat.jpeg", width = 7, height = 7, units = "in", res = 300)
plot(gam_modTCC, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_modTCC)[1], cex=4)
dev.off()
summary(gam_modTCC)
gam.check(gam_modTCC)
concurvity(gam_modTCC, full=TRUE)
```

Do we see similar results with removing one data point?
```{r}
TEST <- foreach(i = 1:nrow(CC_mastersheet6), .combine = "rbind.data.frame") %do% {
  alt <- CC_mastersheet6[-i, ]
  GM <- gam(Trem ~ s(Latitude, k=3), data = alt, method="REML", family=poisson(link="log"))
  c(summary(GM)$s.pv, summary(GM)$r.sq, summary(GM)$dev.expl)
}
CONF <- apply(TEST, 2, function(i) t.test(i)$conf.int)
colnames(CONF) <- c("p_value", "Rsq", "DevExp")
CONF
```

Removing the first record (a _Microtus pennsylvanicus_ with three trematodes) gives a p-value of 0.25 for latitude, but otherwise the removal of everything else seems to stay in line with our overall results.

## Test for Relationship between Richness and Climate Variables and Mass {.tabset}

```{r}
#colnames(mastersheet2)
climdata<-mastersheet2[,c(19:36)]
climdataCor<-cor(climdata)
jpeg(file="CorrelationPlot.jpeg", width = 7, height = 7, units = "in", res = 300)
corrplot(climdataCor)
dev.off()
```

### Total Helminths

```{r}
gam_mod2CC <- gam(TotalHelm ~ PrecipSeason + s(TempAnnRange, k=3) + s(Mass, k=3), data = CC_mastersheet6, method="REML", family=poisson(link="log"), offset=log10(SS_CC))
plot(gam_mod2CC, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2CC)[1], all.terms=TRUE)
summary(gam_mod2CC)
coef(gam_mod2CC)
gam.check(gam_mod2CC)
concurvity(gam_mod2CC, full=FALSE)
#add smooth and k=3 to precip to graph
jpeg(file="Plot_CC_Tot_Precip.jpeg", width = 7, height = 7, units = "in", res = 300)
plot(gam_mod2CC, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2CC)[1], select=1, cex=4)
dev.off()
jpeg(file="Plot_CC_Tot_Temp.jpeg", width = 7, height = 7, units = "in", res = 300)
plot(gam_mod2CC, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2CC)[1], select=2, cex=4)
dev.off()
jpeg(file="Plot_CC_Tot_Mass.jpeg", width = 7, height = 7, units = "in", res = 300)
plot(gam_mod2CC, residuals=TRUE, shade=TRUE, shift = coef(gam_mod2CC)[1], select=3, cex=4)
dev.off()
```

Do we see similar results with removing one data point?
```{r}
TEST <- foreach(i = 1:nrow(CC_mastersheet6), .combine = "rbind.data.frame") %do% {
  alt <- CC_mastersheet6[-i, ]
  GM <- gam(TotalHelm ~ PrecipSeason + s(TempAnnRange, k=3) + s(Mass, k=3), data = alt, method="REML", family=poisson(link="log"), offset=log10(SS_CC))
  c(summary(GM)$p.pv[2], summary(GM)$s.pv, summary(GM)$r.sq, summary(GM)$dev.expl)
}
CONF <- apply(TEST, 2, function(i) t.test(i)$conf.int)
colnames(CONF) <- c("p_value_prec", "p_value_temp", "p_value_mass", "Rsq", "DevExp")
CONF
```

### Nematodes 

```{r}
gam_mod2NCC <- gam(Nem ~ PrecipSeason + TempAnnRange + Mass, data = CC_mastersheet6, method="REML", family=poisson(link="log"))
summary(gam_mod2NCC)
coef(gam_mod2NCC)
gam.check(gam_mod2NCC)
#concurvity(gam_mod2NCC, full=FALSE)
#add smooth and k=3 for all to graph
#jpeg(file="Plot_CC_Nem_Precip.jpeg", width = 7, height = 7, units = "in", res = 300)
#plot(gam_mod2NCC, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2NCC)[1], select=1, cex=4)
#dev.off()
#jpeg(file="Plot_CC_Nem_Temp.jpeg", width = 7, height = 7, units = "in", res = 300)
#plot(gam_mod2NCC, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2NCC)[1], select=2, cex=4)
#dev.off()
#jpeg(file="Plot_CC_Nem_Mass.jpeg", width = 7, height = 7, units = "in", res = 300)
#plot(gam_mod2NCC, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2NCC)[1], select=3, cex=4)
#dev.off()
```

Do we see similar results with removing one data point?
```{r}
TEST <- foreach(i = 1:nrow(CC_mastersheet6), .combine = "rbind.data.frame") %do% {
  alt <- CC_mastersheet6[-i, ]
  GM <- gam(Nem ~ PrecipSeason + TempAnnRange + Mass, data = alt, method="REML", family=poisson(link="log"))
  c(summary(GM)$p.pv[2:4], summary(GM)$r.sq, summary(GM)$dev.expl)
}
CONF <- apply(TEST, 2, function(i) t.test(i)$conf.int)
colnames(CONF) <- c("p_value_prec", "p_value_temp", "p_value_mass", "Rsq", "DevExp")
CONF
```

### Cestodes

```{r}
gam_mod2CCC <- gam(Cest ~ PrecipSeason + s(TempAnnRange, k=3) + s(Mass, k=3), data = CC_mastersheet6, method="REML", family=poisson(link="log"), offset=log10(SS_CC))
summary(gam_mod2CCC)
coef(gam_mod2CCC)
gam.check(gam_mod2CCC)
concurvity(gam_mod2CCC, full=FALSE)
#add smooth and k=3 to precip
jpeg(file="Plot_CC_Cest_Precip.jpeg", width = 7, height = 7, units = "in", res = 300)
plot(gam_mod2CCC, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2CCC)[1], select=1, cex=4)
dev.off()
jpeg(file="Plot_CC_Cest_Temp.jpeg", width = 7, height = 7, units = "in", res = 300)
plot(gam_mod2CCC, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2CCC)[1], select=2, cex=4)
dev.off()
jpeg(file="Plot_CC_Cest_Mass.jpeg", width = 7, height = 7, units = "in", res = 300)
plot(gam_mod2CCC, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2CCC)[1], select=3, cex=4)
dev.off()
```

Do we see similar results with removing one data point?
```{r}
TEST <- foreach(i = 1:nrow(CC_mastersheet6), .combine = "rbind.data.frame") %do% {
  alt <- CC_mastersheet6[-i, ]
  GM <- gam(Cest ~ PrecipSeason + s(TempAnnRange, k=3) + s(Mass, k=3), data = alt, method="REML", family=poisson(link="log"), offset=log10(SS_CC))
  c(summary(GM)$p.pv[2], summary(GM)$s.pv, summary(GM)$r.sq, summary(GM)$dev.expl)
}
CONF <- apply(TEST, 2, function(i) t.test(i)$conf.int)
colnames(CONF) <- c("p_value_prec", "p_value_temp", "p_value_mass", "Rsq", "DevExp")
CONF
TEST[, 2]
```

Again, the removal of the first record, a _Microtus pennsylvanicus_ with 4 cestodes, reveals this is seemingly an outlier (0.21 p-value). However, several other records show a relationship with temperature that is shaky when certain data points are removed.

### Trematodes

```{r}
gam_mod2TCC <- gam(Trem ~ s(PrecipSeason, k=3) + s(TempAnnRange, k=3) + s(Mass, k=3), data = CC_mastersheet6, method="REML", family=poisson(link="log"))
summary(gam_mod2TCC)
coef(gam_mod2TCC)
gam.check(gam_mod2TCC)
concurvity(gam_mod2TCC, full=FALSE)
#add smooth and k=3 to precip
jpeg(file="Plot_CC_Trem_Precip.jpeg", width = 7, height = 7, units = "in", res = 300)
plot(gam_mod2TCC, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2TCC)[1], select=1, cex=4)
dev.off()
jpeg(file="Plot_CC_Trem_Temp.jpeg", width = 7, height = 7, units = "in", res = 300)
plot(gam_mod2TCC, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2TCC)[1], select=2, cex=4)
dev.off()
jpeg(file="Plot_CC_Trem_Mass.jpeg", width = 7, height = 7, units = "in", res = 300)
plot(gam_mod2TCC, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_mod2TCC)[1], select=3, cex=4)
dev.off()
```

Do we see similar results with removing one data point?
```{r}
TEST <- foreach(i = 1:nrow(CC_mastersheet6), .combine = "rbind.data.frame") %do% {
  alt <- CC_mastersheet6[-i, ]
  GM <- gam(Trem ~ s(PrecipSeason, k=3) + s(TempAnnRange, k=3) + s(Mass, k=3), data = alt, method="REML", family=poisson(link="log"))
  c(summary(GM)$s.pv, summary(GM)$r.sq, summary(GM)$dev.expl)
}
CONF <- apply(TEST, 2, function(i) t.test(i)$conf.int)
colnames(CONF) <- c("p_value_prec", "p_value_temp", "p_value_mass", "Rsq", "DevExp")
CONF
TEST[, 1]
CC_mastersheet6[c(2, 10, 15), ]
```

Here, the main culprit seems to be the second, tenth, and fifteenth records, and nothing extremely obvious jumps out here for a cause of this instability.

# Rerunning infra analysis without Texas

```{r}
mastersheet2$State
#Texas_datasheet<-mastersheet2[mastersheet2$Latitude < 35 & mastersheet2$Latitude > 25,]
mastersheetWT<-mastersheet2[-c(150:157,217:261,284:294),]
```

```{r}
gam_modWT <- gam(TotalHelms ~ s(Latitude, k=5), data = mastersheetWT, method="REML", family=poisson(link="log"))
coef(gam_modWT)
plotHLat<-plot(gam_modWT, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_modWT)[1], cex=4)
summary(gam_modWT)
gam.check(gam_modWT)
```

```{r}
gam_modNWT <- gam(NemRich ~ s(Latitude, k=6), data = mastersheetWT, method="REML", family=poisson(link="log"))
coef(gam_modNWT)
plot(gam_modNWT, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_modNWT)[1], cex=4)
summary(gam_modNWT)
gam.check(gam_modNWT)
```

```{r}
gam_modCWT <- gam(CestRich ~ s(Latitude, k=4), data = mastersheetWT, method="REML", family=poisson(link="log"))
coef(gam_modCWT)
plot(gam_modCWT, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_modCWT)[1], cex=4)
summary(gam_modCWT)
gam.check(gam_modCWT)
```

```{r}
gam_modTWT <- gam(TremRich ~ Latitude, data = mastersheetWT, method="REML", family=poisson(link="log"))
#coef(gam_modT)
#plot(gam_modTWT, residuals=TRUE, shade=TRUE, seWithMean = TRUE, shift = coef(gam_modTWT)[1])
summary(gam_modTWT)
gam.check(gam_modTWT)
#concurvity(gam_modT, full=TRUE)
#hist(mastersheet2$TremRich)
```

# Plots

This is just recreating the raincloud plot of Figure 3.

## Figure 3
```{r, fig.width=7, fig.height=7}
test<-ifelse(mastersheet2$Latitude > 55, yes="Churchill", no="other")
#test
mastersheet2[36:78,9]="Winnipeg"
group<-mastersheet2$State
group<-revalue(group, c("Hidalgo"="20 N"))
group<-revalue(group, c("San Ramon"="10 N"))
group<-revalue(group, c("Texas"="30 N"))
group<-revalue(group, c("Nebraska"="40 N"))
group<-revalue(group, c("Winnipeg"="50 N"))
group<-revalue(group, c("Manitoba"="59 N"))
group1  <- factor(group, levels=c("10 N", "20 N", "30 N", "40 N", "50 N", "59 N"))
score<-mastersheet2$TotalHelms
#create a vector of names introducing the degree symbol using unicode
NAMES <- sapply(strsplit(levels(group1), " "), function(x) paste0(x[1], "\u00B0", x[2]))
p1 <- mastersheet2 %>%
  ggplot(aes(x = score,
             y = group,
             fill = group)) +
  ggridges::geom_density_ridges(jittered_points = T,
                                point_size = 2,
                                alpha = 1,
                                position = position_points_jitter(width = 0.2,
                                                                  yoffset = -0.215),
                                point_shape = 21,
                                scale = 0.6,
                                show.legend = F) +
  scale_fill_viridis_d(option = "C", direction = -1) +
  scale_color_viridis_d(option = "C", direction = -1) +
  scale_x_continuous(expand = c(0, 0), breaks = seq(0, 5, 1)) +
  scale_y_discrete(labels = NAMES) +
  labs(x = "Helminth Species Richness",
       y = "Latitude") +
  theme(panel.background = element_rect(fill = "white",
                                       color = "black"),
        panel.border = element_rect(fill = "transparent",
                                    color = "black",
                                    size - 0.8),
        axis.text = element_text(size = 12,
                                 vjust = 0.1),
        axis.title = element_text(size = 16))
p1
#ggsave(file="Raincloud_Richness_DegHel.pdf", p1, scale = 1, width = 7, height = 7, units = "in", dpi = 300)
```
